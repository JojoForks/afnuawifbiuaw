<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞–∑—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö —è—á–µ–µ–∫ Excel</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        #workPanel {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            max-width: 600px;
        }

        select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            color: var(--text-primary);
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="header-left">
            <h1>–†–∞–∑—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —è—á–µ–µ–∫ Excel<span class="info-icon" data-tooltip="–†–∞–∑–±–∏–≤–∞–µ—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ —è—á–µ–π–∫–∏ –≤ Excel –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –∏—Ö –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.">‚ÑπÔ∏è</span></h1>
        </div>
        <div class="controls">
            <input type="file" id="excelFile" accept=".xlsx,.xls">
            <button id="downloadBtn" class="btn btn-success" style="display:none; margin-left: 10px;">üíæ –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
        </div>
    </header>

    <div id="workPanel">
        <div class="card">
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px;">–í—ã–±–µ—Ä–∏—Ç–µ –ª–∏—Å—Ç:</label>
                <select id="sheetName" disabled>
                    <option value="">–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª</option>
                </select>
            </div>

            <button id="processBtn" class="btn btn-primary">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª</button>
            <div id="status" style="margin-top: 10px; color: var(--text-secondary);"></div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º XLSX-Populate –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Excel —Å–æ —Å—Ç–∏–ª—è–º–∏ -->
    <script src="https://unpkg.com/xlsx-populate/browser/xlsx-populate.min.js"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º SheetJS –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ merges -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const excelFileInput = document.getElementById('excelFile');
        const sheetNameSelect = document.getElementById('sheetName');
        const processBtn = document.getElementById('processBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        let processedWorkbook = null;
        let originalFileName = '';

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ª–∏—Å—Ç–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞ (—á–µ—Ä–µ–∑ XLSX-Populate)
        async function loadSheetList(file) {
            try {
                const data = await file.arrayBuffer();
                processedWorkbook = await XlsxPopulate.fromDataAsync(data);

                // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
                sheetNameSelect.innerHTML = '';

                const sheetNames = processedWorkbook.sheets().map(s => s.name());

                sheetNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    sheetNameSelect.appendChild(option);
                });

                if (sheetNames.length > 0) {
                    sheetNameSelect.value = sheetNames[0];
                }

                sheetNameSelect.disabled = false;
                return sheetNames;
            } catch (error) {
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ${error.message}`);
                sheetNameSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞</option>';
                sheetNameSelect.disabled = true;
                processedWorkbook = null;
                return [];
            }
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (SheetJS: –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ merges, XLSX-Populate: –∫–æ–ø–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è/—Å—Ç–∏–ª–∏ –∏ —Ä–∞–∑—ä–µ–¥–∏–Ω—è–µ–º)
        async function processExcelFile(file) {
            try {
                // –í—Å–µ–≥–¥–∞ —á–∏—Ç–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—á–Ω—ã–µ merges —á–µ—Ä–µ–∑ SheetJS
                const data = await file.arrayBuffer();
                if (!processedWorkbook) {
                    processedWorkbook = await XlsxPopulate.fromDataAsync(data);
                }

                originalFileName = file.name.replace(/\.xlsx?$/, '');

                const sheetName = sheetNameSelect.value;
                const sheet = processedWorkbook.sheet(sheetName);
                if (!sheet) throw new Error(`–õ–∏—Å—Ç "${sheetName}" –Ω–µ –Ω–∞–π–¥–µ–Ω`);

                // –ü–æ–ª—É—á–∞–µ–º merges —á–µ—Ä–µ–∑ SheetJS (–Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–π)
                const wbSS = XLSX.read(data, { type: 'array' });
                const wsSS = wbSS.Sheets[sheetName];
                const merges = (wsSS && wsSS['!merges']) ? wsSS['!merges'] : [];
                const mergeRanges = merges.map(m => XLSX.utils.encode_range(m));

                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω: –∫–æ–ø–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ/—Å—Ç–∏–ª—å –∏–∑ –≤–µ—Ä—Ö–Ω–µ–π-–ª–µ–≤–æ–π —è—á–µ–π–∫–∏ –≤–æ –≤—Å–µ —è—á–µ–π–∫–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –∏ —Å–Ω–∏–º–∞–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ
                // –°–ø–∏—Å–æ–∫ —Å–≤–æ–π—Å—Ç–≤ —Å—Ç–∏–ª–µ–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö XLSX-Populate
                const styleProps = [
                    'bold', 'italic', 'underline', 'strikethrough',
                    'fontColor', 'fontFamily', 'fontSize',
                    'horizontalAlignment', 'verticalAlignment',
                    'wrapText', 'shrinkToFit', 'textRotation',
                    'numberFormat', 'fill', 'border'
                ];

                for (const rangeStr of mergeRanges) {
                    const rng = sheet.range(rangeStr);
                    const tl = rng.startCell();
                    const br = rng.endCell();
                    const tlRow = tl.rowNumber();
                    const tlCol = tl.columnNumber();
                    const brRow = br.rowNumber();
                    const brCol = br.columnNumber();

                    // –ë–µ—Ä–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ. –ï—Å–ª–∏ —Ñ–æ—Ä–º—É–ª–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                    const baseValue = tl.value();

                    // –°–Ω–∏–º–∞–µ–º —Å–ª–µ–ø–æ–∫ —Å—Ç–∏–ª—è –∫–∞–∫ –ø—Ä–æ—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç
                    const baseStyleObj = {};
                    for (const prop of styleProps) {
                        try {
                            const val = tl.style(prop);
                            if (val !== undefined && val !== null) {
                                baseStyleObj[prop] = val;
                            }
                        } catch (e) {
                            // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
                        }
                    }

                    for (let r = tlRow; r <= brRow; r++) {
                        for (let c = tlCol; c <= brCol; c++) {
                            const cell = sheet.cell(r, c);
                            cell.value(baseValue);
                            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª—å –ø–æ –æ–±—ä–µ–∫—Ç—É —Å–≤–æ–π—Å—Ç–≤
                            try {
                                if (Object.keys(baseStyleObj).length > 0) {
                                    cell.style(baseStyleObj);
                                }
                            } catch (e) {
                                // –í —Å–ª—É—á–∞–µ —Å–ø–µ—Ü.—Å—Ç–∏–ª–µ–π –ø—Ä–æ–ø—É—Å–∫–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞—Ç—å
                            }
                        }
                    }

                    rng.merged(false);
                }

                return true;
            } catch (error) {
                alert(`–û—à–∏–±–∫–∞: ${error.message}`);
                return false;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
        async function downloadProcessedFile() {
            if (!processedWorkbook) return;
            try {
                const outputFileName = `${originalFileName}_unmerged.xlsx`;
                const out = await processedWorkbook.outputAsync();
                const blob = out instanceof Blob ? out : new Blob([out], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = outputFileName;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            } catch (error) {
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ${error.message}`);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞
        excelFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                await loadSheetList(file);
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        processBtn.addEventListener('click', async () => {
            const file = excelFileInput.files[0];
            if (!file) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
                return;
            }

            if (!sheetNameSelect.value) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ª–∏—Å—Ç');
                return;
            }

            processBtn.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
            processBtn.disabled = true;

            const success = await processExcelFile(file);

            processBtn.disabled = false;
            if (success) {
                processBtn.textContent = '–§–∞–π–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω';
                downloadBtn.style.display = 'inline-block';
            } else {
                processBtn.textContent = '–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª';
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        downloadBtn.addEventListener('click', downloadProcessedFile);
    </script>
</body>
</html>
