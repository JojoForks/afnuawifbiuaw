<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<title>–û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä GeoJSON</title>
	<link rel="stylesheet" href="styles.css">
	<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
	<style>
		/* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è optimize_geojson */
		body {
			padding: 1.5rem;
		}

		h1 {
			margin-bottom: 1.5rem;
			font-size: 1.75rem;
		}

		label {
			display: inline-block;
			margin-bottom: 0.5rem;
		}

		input[type="file"],
		input[type="text"] {
			width: 100%;
			max-width: 400px;
			margin-bottom: 1rem;
		}

		input[type="range"] {
			max-width: 400px;
			margin: 0.5rem 0;
		}

		#map {
			height: 500px;
			border: 1px solid var(--border-color);
			border-radius: var(--radius-lg);
		}

		.leaflet-bottom.leaflet-right {
			display: none !important;
			margin: 1rem 0;
		}

		.stats-panel {
			display: flex;
			gap: 2rem;
			flex-wrap: wrap;
			margin: 1rem 0;
		}

		.stat-card {
			min-width: 180px;
			padding: 1rem 1.5rem;
		}

		.legend-color.original { background: #3388ff; }
		.legend-color.optimized { background: var(--accent-color); }
		.legend-dot.original { background: #2563eb; border: 1px solid #1d4ed8; }
		.legend-dot.optimized { background: var(--accent-color); border: 1px solid #dc2626; }

		.checkbox-label {
			display: flex;
			align-items: center;
			gap: 0.5rem;
			cursor: pointer;
			font-weight: 500;
		}

		.checkbox-label input[type="checkbox"] {
			-webkit-appearance: none;
			appearance: none;
			width: 18px;
			height: 18px;
			border: 2px solid var(--border-color);
			border-radius: 4px;
			background-color: var(--bg-color);
			cursor: pointer;
			position: relative;
			margin: 0;
		}

		.checkbox-label input[type="checkbox"]:checked {
			background-color: var(--accent-color);
			border-color: var(--accent-color);
		}

		.checkbox-label input[type="checkbox"]:checked::after {
			content: '';
			position: absolute;
			left: 5px;
			top: 2px;
			width: 4px;
			height: 8px;
			border: solid white;
			border-width: 0 2px 2px 0;
			transform: rotate(45deg);
		}

		.checkbox-label input[type="checkbox"]:hover {
			border-color: var(--accent-color);
		}
	</style>
</head>
<body>
	<h1>üó∫Ô∏è –û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä GeoJSON</h1>

	<div class="group">
		<label>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ/UUID –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª:</label><br>
		<input type="text" id="urlInput" placeholder="UUID –∏–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ" style="margin-bottom: 0.5rem;"><br>
		<input type="file" id="geojsonFile" accept=".geojson,.json">
		<div id="fileInfo" style="margin-top: 0.5rem; font-weight: 500;"></div>
		<br>
		<button id="loadButton" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
	</div>

	<div id="workPanel" style="display: none;">
		<div class="stats-panel">
			<div class="stat-card">
				<div class="stat-label">–ò—Å—Ö–æ–¥–Ω—ã—Ö —Ç–æ—á–µ–∫</div>
				<div class="stat-value" id="originalPoints">0</div>
			</div>
			<div class="stat-card">
				<div class="stat-label">–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</div>
				<div class="stat-value" id="optimizedPoints">0</div>
			</div>
			<div class="stat-card">
				<div class="stat-label">–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ</div>
				<div class="stat-value" id="reductionPercent">0%</div>
			</div>
		</div>

		<div class="group">
			<label for="toleranceRange">–£—Ä–æ–≤–µ–Ω—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (tolerance):</label>
			<span class="tolerance-display" id="toleranceValue">0.0010</span>
			<br>
			<input type="range" id="toleranceRange" min="0" max="0.1" step="0.0001" value="0.001">
			<br><br>
			<div class="legend">
				<div class="legend-item">
					<div class="legend-color original"></div>
					<span>–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–Ω—Ç—É—Ä</span>
				</div>
				<div class="legend-item">
					<div class="legend-color optimized"></div>
					<span>–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π</span>
				</div>
				<div class="legend-item">
					<div class="legend-dot original"></div>
					<span>–ò—Å—Ö–æ–¥–Ω—ã–µ —Ç–æ—á–∫–∏</span>
				</div>
				<div class="legend-item">
					<div class="legend-dot optimized"></div>
					<span>–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ—á–∫–∏</span>
				</div>
			</div>
			<br>
			<div class="checkbox-group">
				<label class="checkbox-label">
					<input type="checkbox" id="toggleOriginal" checked>
					<span>–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π</span>
				</label>
				<label class="checkbox-label">
					<input type="checkbox" id="toggleOptimized" checked>
					<span>–ü–æ–∫–∞–∑–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π</span>
				</label>
				<label class="checkbox-label">
					<input type="checkbox" id="togglePoints" checked>
					<span>–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ—á–∫–∏</span>
				</label>
				<label class="checkbox-label">
					<input type="checkbox" id="toggleMulticolor">
					<span>–†–∞–∑–Ω–æ—Ü–≤–µ—Ç–Ω—ã–µ –∑–æ–Ω—ã</span>
				</label>
			</div>
		</div>

		<div id="map"></div>

		<div class="group">
			<button id="downloadGeoJSONButton" class="btn btn-success">üíæ –°–∫–∞—á–∞—Ç—å GeoJSON</button>
			<button id="downloadPlanningButton" class="btn btn-success" style="display: none; margin-left: 12px;">üíæ –°–∫–∞—á–∞—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
		</div>
	</div>

	<script>
		let map = null;
		let originalGeoJSON = null;
		let optimizedGeoJSON = null;
		let planningData = null;
		let fileType = null; // 'geojson' –∏–ª–∏ 'planning'

		let originalLayer = null;
		let optimizedLayer = null;
		let originalPointsLayer = null;
		let optimizedPointsLayer = null;

		let showOriginal = true;
		let showOptimized = true;
		let showPoints = true;
		let multicolorMode = false;

		// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
		function determineFileType(data) {
			if (data && typeof data === 'object') {
				if (data.zones && Array.isArray(data.zones)) {
					return 'planning';
				}
				if (data.features && Array.isArray(data.features)) {
					return 'geojson';
				}
			}
			return 'unknown';
		}

		// –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ GeoJSON
		function planningToGeoJSON(planning) {
			return {
				type: 'FeatureCollection',
				features: planning.zones.map(zone => ({
					type: 'Feature',
					geometry: zone.geometry,
					properties: {
						id: zone.id,
						description: zone.id
					}
				}))
			};
		}

		// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≥–µ–æ–º–µ—Ç—Ä–∏–π –∫ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é
		function applyOptimizedToPlanning() {
			if (!planningData || !optimizedGeoJSON) return null;

			const updatedPlanning = JSON.parse(JSON.stringify(planningData));
			
			// –°–æ–∑–¥–∞—ë–º –º–∞–ø–ø–∏–Ω–≥ id -> –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≥–µ–æ–º–µ—Ç—Ä–∏—è
			const geometryMap = new Map();
			if (optimizedGeoJSON.features) {
				optimizedGeoJSON.features.forEach(feature => {
					const id = feature.properties?.id || feature.properties?.description;
					if (id) {
						geometryMap.set(id, feature.geometry);
					}
				});
			}

			// –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≥–µ–æ–º–µ—Ç—Ä–∏–∏
			updatedPlanning.zones = updatedPlanning.zones.map(zone => {
				const optimizedGeometry = geometryMap.get(zone.id);
				if (optimizedGeometry) {
					return { ...zone, geometry: optimizedGeometry };
				}
				return zone;
			});

			return updatedPlanning;
		}

		// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ü–≤–µ—Ç–∞ –ø–æ –∏–Ω–¥–µ–∫—Å—É
		function getColorByIndex(index, total) {
			const hue = (index * 360 / total) % 360;
			return `hsl(${hue}, 70%, 50%)`;
		}

		function getDarkerColor(index, total) {
			const hue = (index * 360 / total) % 360;
			return `hsl(${hue}, 70%, 35%)`;
		}

		const toleranceRange = document.getElementById('toleranceRange');
		const toleranceValue = document.getElementById('toleranceValue');

		// –ü–æ–¥—Å—á—ë—Ç —Ç–æ—á–µ–∫ –≤ GeoJSON
		function countPoints(geojson) {
			let count = 0;
			const coords = turf.coordAll(geojson);
			return coords.length;
		}

		// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–∞–∫ –º–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫
		function getAllCoordinates(geojson) {
			return turf.coordAll(geojson);
		}

		// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
		function updateStats() {
			if (!originalGeoJSON || !optimizedGeoJSON) return;

			const originalCount = countPoints(originalGeoJSON);
			const optimizedCount = countPoints(optimizedGeoJSON);
			const reduction = originalCount > 0 
				? Math.round((1 - optimizedCount / originalCount) * 100) 
				: 0;

			document.getElementById('originalPoints').textContent = originalCount.toLocaleString();
			document.getElementById('optimizedPoints').textContent = optimizedCount.toLocaleString();
			document.getElementById('reductionPercent').textContent = reduction + '%';
		}

		// –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ—è —Å —Ç–æ—á–∫–∞–º–∏
		function createPointsLayer(coords, color, radius) {
			const markers = [];
			coords.forEach(coord => {
				const marker = L.circleMarker([coord[1], coord[0]], {
					radius: radius,
					fillColor: color,
					color: color === '#2563eb' ? '#1d4ed8' : '#dc2626',
					weight: 1,
					opacity: 0.8,
					fillOpacity: 0.6
				});
				markers.push(marker);
			});
			return L.layerGroup(markers);
		}

		// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã
		function updateMap() {
			if (!map || !originalGeoJSON) return;

			// –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–ª–æ–∏
			if (originalLayer) map.removeLayer(originalLayer);
			if (optimizedLayer) map.removeLayer(optimizedLayer);
			if (originalPointsLayer) map.removeLayer(originalPointsLayer);
			if (optimizedPointsLayer) map.removeLayer(optimizedPointsLayer);

			// –ü–æ–¥—Å—á—ë—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ–∏—á –¥–ª—è —Ü–≤–µ—Ç–æ–≤
			let featureCount = 1;
			if (originalGeoJSON.features) {
				featureCount = originalGeoJSON.features.length;
			}

			// –ò—Å—Ö–æ–¥–Ω—ã–π —Å–ª–æ–π
			if (showOriginal) {
				let featureIndex = 0;
				originalLayer = L.geoJSON(originalGeoJSON, {
					style: function(feature) {
						if (multicolorMode) {
							const color = getColorByIndex(featureIndex++, featureCount);
							return {
								color: color,
								weight: 3,
								fillColor: color,
								fillOpacity: 0.2,
								opacity: 0.8
							};
						}
						return {
							color: '#3388ff',
							weight: 3,
							fillOpacity: 0.1,
							opacity: 0.7
						};
					},
					onEachFeature: function(feature, layer) {
						// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–æ–Ω—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
						let name = feature.properties?.name || feature.properties?.description || feature.properties?.id || '';
						if (name) {
							layer.bindTooltip(name, { sticky: true });
						}
					}
				}).addTo(map);
			}

			// –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ª–æ–π
			if (showOptimized && optimizedGeoJSON) {
				let featureIndex = 0;
				optimizedLayer = L.geoJSON(optimizedGeoJSON, {
					style: function(feature) {
						if (multicolorMode) {
							const color = getColorByIndex(featureIndex++, featureCount);
							return {
								color: getDarkerColor(featureIndex - 1, featureCount),
								weight: 2,
								fillColor: color,
								fillOpacity: 0.25,
								opacity: 0.9
							};
						}
						return {
							color: '#ff4b4b',
							weight: 2,
							fillOpacity: 0.15,
							opacity: 0.9
						};
					},
					onEachFeature: function(feature, layer) {
						let name = feature.properties?.name || feature.properties?.description || feature.properties?.id || '';
						if (name) {
							layer.bindTooltip(name, { sticky: true });
						}
					}
				}).addTo(map);
			}

			// –¢–æ—á–∫–∏
			if (showPoints && !multicolorMode) {
				if (showOriginal) {
					const originalCoords = getAllCoordinates(originalGeoJSON);
					originalPointsLayer = createPointsLayer(originalCoords, '#2563eb', 4);
					originalPointsLayer.addTo(map);
				}

				if (showOptimized && optimizedGeoJSON) {
					const optimizedCoords = getAllCoordinates(optimizedGeoJSON);
					optimizedPointsLayer = createPointsLayer(optimizedCoords, '#ff4b4b', 5);
					optimizedPointsLayer.addTo(map);
				}
			}
		}

		// –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å —Ç–µ–∫—É—â–∏–º tolerance
		function optimize() {
			if (!originalGeoJSON) return;

			const tolerance = parseFloat(toleranceRange.value);
			toleranceValue.textContent = tolerance.toFixed(4);

			try {
				optimizedGeoJSON = turf.simplify(originalGeoJSON, {
					tolerance: tolerance,
					highQuality: true
				});
			} catch (err) {
				console.error('–û—à–∏–±–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:', err);
				optimizedGeoJSON = originalGeoJSON;
			}

			updateStats();
			updateMap();
		}

		// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
		function initMap() {
			if (map) return;

			map = L.map('map').setView([55.7558, 37.6173], 10);
			L.tileLayer('https://tiles.api-maps.yandex.ru/v1/tiles/?apikey=567685cf-50f2-407c-9545-c91fd8b9c384&lang=ru_RU&x={x}&y={y}&z={z}&l=map&projection=web_mercator', {
				maxZoom: 20,
				attribution: '&copy; –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã'
			}).addTo(map);
		}

		// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
		function processLoadedData(data) {
			fileType = determineFileType(data);
			
			const fileInfo = document.getElementById('fileInfo');
			const planningBtn = document.getElementById('downloadPlanningButton');

			if (fileType === 'planning') {
				planningData = data;
				originalGeoJSON = planningToGeoJSON(data);
				const zoneCount = data.zones.length;
				fileInfo.textContent = `–§–∞–π–ª –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ${zoneCount} –∑–æ–Ω`;
				fileInfo.style.color = '#28a745';
				planningBtn.style.display = 'inline-block';
			} else if (fileType === 'geojson') {
				planningData = null;
				originalGeoJSON = data;
				const featureCount = data.features ? data.features.length : 0;
				fileInfo.textContent = `GeoJSON: ${featureCount} –æ–±—ä–µ–∫—Ç–æ–≤`;
				fileInfo.style.color = '#007bff';
				planningBtn.style.display = 'none';
			} else {
				fileInfo.textContent = '–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞';
				fileInfo.style.color = '#dc3545';
				return false;
			}

			document.getElementById('workPanel').style.display = 'block';
			
			initMap();
			
			setTimeout(() => {
				map.invalidateSize();
				optimize();

				// –ü–æ–¥–≥–æ–Ω—è–µ–º –∫–∞—Ä—Ç—É –ø–æ–¥ –≥—Ä–∞–Ω–∏—Ü—ã
				if (originalLayer) {
					try {
						map.fitBounds(originalLayer.getBounds().pad(0.1));
					} catch (err) {}
				} else if (optimizedLayer) {
					try {
						map.fitBounds(optimizedLayer.getBounds().pad(0.1));
					} catch (err) {}
				}
			}, 100);

			return true;
		}

		// –ü—Ä–µ–≤—å—é –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
		document.getElementById('geojsonFile').addEventListener('change', function(e) {
			const file = e.target.files[0];
			const fileInfo = document.getElementById('fileInfo');
			
			if (file) {
				fileInfo.textContent = `–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${file.name}`;
				fileInfo.style.color = '#666';
			} else {
				fileInfo.textContent = '';
			}
		});

		// –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
		document.getElementById('loadButton').addEventListener('click', async function() {
			const urlInput = document.getElementById('urlInput').value.trim();
			const fileInput = document.getElementById('geojsonFile');
			const fileInfo = document.getElementById('fileInfo');

			// –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: URL > —Ñ–∞–π–ª
			if (urlInput) {
				const uuidMatch = urlInput.match(/([a-f0-9]+-[a-f0-9]+-[a-f0-9]+-[a-f0-9]+)/i);
				if (!uuidMatch) {
					alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ UUID');
					return;
				}

				const uuid = uuidMatch[0];
				const apiUrl = `https://routeq.gens.codes/request/${uuid}`;

				fileInfo.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
				fileInfo.style.color = '#666';

				try {
					const response = await fetch(apiUrl);
					if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);
					const data = await response.json();
					
					if (!processLoadedData(data)) {
						throw new Error('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
					}
				} catch (err) {
					console.error(err);
					fileInfo.textContent = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}`;
					fileInfo.style.color = '#dc3545';
				}
				return;
			}

			// –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ —Ñ–∞–π–ª–∞
			if (!fileInput.files.length) {
				alert('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É/UUID –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.');
				return;
			}

			const file = fileInput.files[0];
			const reader = new FileReader();
			reader.onload = function(e) {
				try {
					const data = JSON.parse(e.target.result);
					processLoadedData(data);
				} catch (err) {
					alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + err.message);
				}
			};
			reader.readAsText(file);
		});

		// –ò–∑–º–µ–Ω–µ–Ω–∏–µ tolerance - –ø–µ—Ä–µ—Å—á—ë—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
		toleranceRange.addEventListener('input', function() {
			optimize();
		});

		// –ß–µ–∫–±–æ–∫—Å—ã –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏
		document.getElementById('toggleOriginal').addEventListener('change', function() {
			showOriginal = this.checked;
			updateMap();
		});

		document.getElementById('toggleOptimized').addEventListener('change', function() {
			showOptimized = this.checked;
			updateMap();
		});

		document.getElementById('togglePoints').addEventListener('change', function() {
			showPoints = this.checked;
			updateMap();
		});

		document.getElementById('toggleMulticolor').addEventListener('change', function() {
			multicolorMode = this.checked;
			updateMap();
		});

		// –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
		function downloadFile(data, filename) {
			const dataStr = JSON.stringify(data, null, 2);
			const blob = new Blob([dataStr], { type: 'application/json' });
			const url = URL.createObjectURL(blob);

			const a = document.createElement('a');
			a.href = url;
			a.download = filename;
			document.body.appendChild(a);
			a.click();
			document.body.removeChild(a);
			URL.revokeObjectURL(url);
		}

		// –°–∫–∞—á–∏–≤–∞–Ω–∏–µ GeoJSON
		document.getElementById('downloadGeoJSONButton').addEventListener('click', function() {
			if (!optimizedGeoJSON) {
				alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª.');
				return;
			}
			downloadFile(optimizedGeoJSON, 'optimized.geojson');
		});

		// –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
		document.getElementById('downloadPlanningButton').addEventListener('click', function() {
			if (!planningData || !optimizedGeoJSON) {
				alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.');
				return;
			}
			const updatedPlanning = applyOptimizedToPlanning();
			if (updatedPlanning) {
				downloadFile(updatedPlanning, 'optimized_planning.json');
			}
		});
	</script>
</body>
</html>
